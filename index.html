<!DOCTYPE html>
<html>
    <head>
        <style>
            /* Set the size of the div element that contains the map */
            #map {
                height: 100%;  /* The height is 400 pixels */
                width: 100%;  /* The width is the width of the web page */
            }

            body, html, #content-container {
                margin: 0px;
                height: 100%;
                width: 100%;
            }

            #pane{
                background-color: white;
                height: 90%;
                width: 400px;
                position: absolute;
                top: 5%;
                z-index: 3;
            }
        </style>
    </head>
    <body>
        <div id="content-container">
            <!--The div element for the map -->
            <div id="map"></div>
            <div id="pane">
                <div>
                    <input type="checkbox" checked name="filter" id="casual-dining" onchange="filterMarkers(this)">
                    <label for='casual-dining'>Casual Dining</label>
                    <input type="checkbox" checked name="filter" id="fine-dining" onchange="filterMarkers(this)">
                    <label for='fine-dining'>Fine Dining</label>
                </div>
                <div>
                    <span id="specialties"></span>
                </div>
            </div>
        </div>
    </body>
    <script>

        // The location of Cebu
        const cebu = {lat: 10.488, lng: 123.880};
        let map, infoWindow, geoData;

        let markers = [];

        const loadJSON = (callback) => {
            let xobj = new XMLHttpRequest();
            xobj.overrideMimeType("application/json");
            xobj.open('GET', 'static/js/data.json', true);
            xobj.onreadystatechange = () => {
                if (xobj.readyState === 4 && xobj.status === 200) {
                    // Required use of an anonymous callback
                    // as .open() will NOT return a value but simply returns undefined in asynchronous mode
                    callback(xobj.responseText);
                }
            };
            xobj.send(null);
        }



        function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(
    browserHasGeolocation
      ? "Error: The Geolocation service failed."
      : "Error: Your browser doesn't support geolocation."
  );
  infoWindow.open(map);
}

        // Adds a marker to the map and push to the array.
        function addMarker(location, id) {
            let marker = new google.maps.Marker({
                position: location,
                map: map,
                id: id
            });

            marker.addListener("click", function() {
                map.setZoom(14);
                // map.setCenter(marker.getPosition());
                map.panTo(location);

                let restaurant_data = geoData.features[marker.id]
                document.getElementById("specialties").innerHTML = restaurant_data.properties.specialty.join(", ");
                console.log(restaurant_data);

            });

            markers.push(marker);
        }

        // Sets the map on all markers in the array.
        function setMapOnAll(map) {
            for (let i = 0; i < markers.length; i++) {
                markers[i].setMap(map);
            }
        }

        // Removes the markers from the map, but keeps them in the array.
        function clearMarkers() {
            setMapOnAll(null);
        }

        // Shows any markers currently in the array.
        function showMarkers() {
            setMapOnAll(map);
        }

        // Deletes all markers in the array by removing references to them.
        function deleteMarkers() {
            clearMarkers();
            markers = [];
        }

        // Initialize and add the map
        function initMap() {

            // The map, centered at Cebu
            map = new google.maps.Map(
                document.getElementById('map'), {
                zoom: 12, center: cebu,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false

            });

            loadJSON((response) => {
                // Parse JSON string into object
                geoData = JSON.parse(response);
                for (let ctr = 0; ctr < geoData.features.length; ctr++){
                    let coords = geoData.features[ctr].geometry.coordinates;
                    let latLng = new google.maps.LatLng(coords[0],coords[1]);
                    addMarker(latLng, ctr);
                }

            });

            infoWindow = new google.maps.InfoWindow();

            if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition((position)=>{
        let pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };

        infoWindow.setPosition(pos);
        infoWindow.setContent("Location found.");
        infoWindow.open(map);
        map.setCenter(pos);
    }
      ,
      () => {
        handleLocationError(true, infoWindow, map.getCenter());
      }
    );
  } else {
    // Browser doesn't support Geolocation
    handleLocationError(false, infoWindow, map.getCenter());
  }

        }

        function filterMarkers(state){

            console.log(state.checked, "state");
            filtered_markers = geoData.features.filter((data)=>{
                return data.properties.type === state.id
            });

            console.log(filtered_markers, "fm")

            for (let ctr = 0; ctr < filtered_markers.length; ctr++){

                if (state.checked){
                    markers[filtered_markers[ctr].properties.id].setVisible(true);
                }else{
                    markers[filtered_markers[ctr].properties.id].setVisible(false);
                }
            }

            // if (state.checked){
            //     for (let ctr2 = 0; ctr2 < filtered_markers.length; ctr2++){
            //         // let coords = new_marker[ctr2].geometry.coordinates;
            //         // let latLng = new google.maps.LatLng(coords[0],coords[1]);
            //         // addMarker(latLng, new_marker[ctr2].properties.id);

            //         markers[filtered_markers.properties.id].setVisible(true);
            //     }
            // }else{

            //     for (let ctr2 = 0; ctr2 < filtered_markers.length; ctr2++){
            //         // let coords = new_marker[ctr2].geometry.coordinates;
            //         // let latLng = new google.maps.LatLng(coords[0],coords[1]);
            //         // addMarker(latLng, new_marker[ctr2].properties.id);

            //         markers[filtered_markers.properties.id].setVisible(false);
            //     }
            // }
            // console.log(state, "state value");
            // let filter_type = document.querySelectorAll("input:checked");

            // deleteMarkers();
            // for (let ctr1 = 0; ctr1 < filter_type.length; ctr1++){
            //     let new_marker = geoData.features.filter((data)=>{
            //         return data.properties.type === filter_type[ctr1].id
            //     });
            //     for (let ctr2 = 0; ctr2 < new_marker.length; ctr2++){
            //         let coords = new_marker[ctr2].geometry.coordinates;
            //         let latLng = new google.maps.LatLng(coords[0],coords[1]);
            //         addMarker(latLng, new_marker[ctr2].properties.id);
            //     }
            // }
            // showMarkers();
        }



    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdAb96ekVOdqHZv8O3rMIwxKf_WdRA65M&callback=initMap"></script>
</html>